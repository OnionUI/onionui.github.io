<!DOCTYPE html>
<html>
<head>
    <title>Icon Pack Preview</title>
<style>
:root {
    --main-bg-color: #333333;
    --icon-max-width: 150px;
    --icon-max-height: 150px;
}

body {
    background-color: var(--main-bg-color);
    font-family: sans-serif;
    color: rgba(128,128,128,1);
}

h2 {
    margin-top: 2em;
}

input {
    background-color: var(--main-bg-color);
    border: 1px solid rgba(128,128,128,0.5);
    color: rgba(128,128,128,1);
}

label {
    font-size: .8em;
}

input[type=checkbox] + label {
    opacity: .75;
    user-select: none;
    cursor: pointer;
}

input[type=checkbox] + label:hover, input[type=checkbox]:hover + label {
    opacity: 1;
}

.icons-container {
    display: flex;
    flex-wrap: wrap;
    margin-top: 20px;
}

.icon-preview-container {
    position: relative;
    width: var(--icon-max-width);
    height: var(--icon-max-height);
}

.icon-preview-container .icon-preview.selected {
    visibility: hidden;
}

.all-selected .icon-preview-container .icon-preview {
    visibility: hidden;
}

.icon-preview-container:hover .icon-preview.selected,
.all-selected .icon-preview-container .icon-preview.selected {
    visibility: visible;
}

.icon-preview-container {
    position: relative;
    overflow: hidden;
    width: var(--icon-max-width);
    height: var(--icon-max-height);
    box-sizing: border-box;
    border: 1px solid rgba(128,128,128,0.25);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: -1px;
    margin-left: -1px;
}

.show-only-existing .icon-preview-container {
    display: none;
}

.icon-preview-container.has-icon, .show-only-existing .icon-preview-container.has-icon {
    display: flex;
}

.icon-preview-container:hover {
    border-color: rgba(128,128,128,1);
    z-index: 1;
}

.icon-preview-container::after {
    display: block;
    position: absolute;
    content: attr(data-icon);
    bottom: 10px;
    opacity: 0.5;
    font-family: monospace;
    font-size: 16px;
}

.icon-preview {
    position: absolute;
    width: var(--icon-max-width);
    height: var(--icon-max-height);
    background-color: var(--main-bg-color);
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>
</head>
<body>
<script>
const icons = ['32X', '5200', '7800', 'amiga', 'arcade', 'atari', 'atarist', 'c64', 'col', 'cpc', 'cps1', 'cps2', 'cps3', 'dos', 'fairchild', 'fc', 'fds', 'gb', 'gba', 'gbc', 'gg', 'gw', 'itv', 'lynx', 'md', 'megaduck', 'ms', 'msx', 'neocd', 'neogeo', 'ngp', 'ody', 'pce', 'pcecd', 'pico', 'poke', 'ports', 'ps', 'satella', 'scummvm', 'search', 'segacd', 'segasgone', 'sfc', 'sgb', 'sgfx', 'sufami', 'supervision', 'tic', 'vb', 'vdp', 'vectrex', 'ws', 'zxs'];

const dirname = path => path.substring(0, path.lastIndexOf('/'));
const basename = path => path.substring(path.lastIndexOf('/') + 1);

let main_bg_color = localStorage.getItem('main-bg-color') || "#333333";
let is_all_selected = sessionStorage.getItem('all-selected') == "on";
let show_only_existing = sessionStorage.getItem('show-only-existing') != "off";
let auto_refresh = location.protocol == "file:" ? (sessionStorage.getItem('auto-refresh') == "on") : false;
let auto_refresh_timer = -1;
let icon_counts = [];

function incrementIconCount(pack_id, index) {
    icon_counts[index]++;
    document.getElementById(`${pack_id}_counter`).textContent = icon_counts[index];
    document.getElementById(`${pack_id}_percentage`).textContent = Math.round(icon_counts[index] / icons.length * 100);
}

function setBackgroundColor(color) {
    localStorage.setItem('main-bg-color', color);
    document.body.style.setProperty('--main-bg-color', color);
    main_bg_color = color;
}

function setAllSelected(enabled) {
    sessionStorage.setItem('all-selected', enabled ? 'on' : 'off');
    document.body.classList.toggle('all-selected', enabled);
    is_all_selected = enabled;
}

function setShowOnlyExisting(enabled) {
    sessionStorage.setItem('show-only-existing', enabled ? 'on' : 'off');
    document.body.classList.toggle('show-only-existing', enabled);
    show_only_existing = enabled;
}

function setAutoRefresh(enabled) {
    sessionStorage.setItem('auto-refresh', enabled ? 'on' : 'off');
    auto_refresh = enabled;
    clearTimeout(auto_refresh_timer);

    if (auto_refresh) {
        auto_refresh_timer = setTimeout(() => {
            location.reload();
        }, 10000);
    }
}

function main() {
    let doc_title = basename(dirname(decodeURI(location.href)));

    if (doc_title == "icons")
        doc_title = basename(dirname(dirname(decodeURI(location.href))));

    let icon_packs = [];

    if (location.hash) {
        let hash = location.hash.substring(1);

        let has_multi = hash.indexOf(",") != -1;
        let hash_parts = has_multi ? hash.split(",") : [hash];
        
        doc_title = decodeURI(hash_parts[0]);

        for (let i = 1; i < hash_parts.length; i++) {
            let [ title, path ] = hash_parts[i].split(":");

            if (title == "background") {
                main_bg_color = path;
                continue;
            }

            icon_packs.push({ title, path: `https://raw.githubusercontent.com/OnionUI/Themes/main/${path}/` });
        }

        if (icon_packs.length == 0) {
            icon_packs.push({ title: doc_title, path: `https://raw.githubusercontent.com/OnionUI/Themes/main/icons/${hash_parts[0]}/` });
        }
    }
    else {
        icon_packs.push({ title: doc_title, path: "./" });
    }

    document.body.style.setProperty('--main-bg-color', main_bg_color);
    document.body.classList.toggle('all-selected', is_all_selected);
    document.body.classList.toggle('show-only-existing', show_only_existing);

    document.title = "Icon Pack: " + doc_title;

    let html = "";

    html += `<h1>Icon Pack: ${doc_title}</h1>`;

    html += `<label for="set_bg_color">Background color: </label><input size="10" id="set_bg_color" value="${main_bg_color}" onblur="setBackgroundColor(this.value);" onkeydown="if (event.keyCode == 13) setBackgroundColor(this.value);">`;
    html += "&nbsp;&nbsp;";
    html += `<input type="checkbox"${is_all_selected ? " checked" : ""} id="all_selected_checkbox" onclick="setAllSelected(this.checked)"><label for="all_selected_checkbox"> Show only selected state</label>`;
    html += "&nbsp;&nbsp;";
    html += `<input type="checkbox"${show_only_existing ? " checked" : ""} id="show_only_existing_checkbox" onclick="setShowOnlyExisting(this.checked)"><label for="show_only_existing_checkbox"> Hide missing icons</label>`;

    if (location.protocol == "file:") {
        html += "&nbsp;&nbsp;";
        html += `<input type="checkbox"${auto_refresh ? " checked" : ""} id="auto_refresh_checkbox" onclick="setAutoRefresh(this.checked)"><label for="auto_refresh_checkbox"> Auto refresh (10s)</label>`;
    }

    icon_counts = new Array(icon_packs.length).fill(0);

    for (const [index, icon_pack] of icon_packs.entries()) {
        let icon_pack_id = `icon_pack_${index}`;

        html += `<h2>${decodeURI(icon_pack.title)}</h2>`;
        html += `<div><label><span id="${icon_pack_id}_counter">0</span>/${icons.length} icons (<span id="${icon_pack_id}_percentage">0</span>% complete)</label></div>`;
        html += `<div class="icons-container" id="${icon_pack_id}">`;

        for (icon of icons) {
            html += 
                `<div class="icon-preview-container" data-icon="${icon}">
                    <div class="icon-preview"><img src="${icon_pack.path}${icon}.png" style="display:none;" onerror="this.parentNode.style.display='none'" onload="this.style.display='';this.parentNode.parentNode.classList.add('has-icon');incrementIconCount('${icon_pack_id}', ${index})"></div>
                    <div class="icon-preview selected"><img src="${icon_pack.path}sel/${icon}.png" style="display:none;" onerror="this.parentNode.style.display='none'" onload="this.style.display='';this.parentNode.parentNode.classList.add('has-icon')"></div>
                </div>`;
        }

        html += '</div>';
    }

    document.body.innerHTML = html;

    if (location.protocol == "file:") {
        setAutoRefresh(auto_refresh);
    }
}

document.body.onload = main;
</script>
</body>
</html>
